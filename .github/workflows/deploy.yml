name: GCP â€“ List VMs via OIDC

on:
  workflow_dispatch:
  push:
    branches: [ main-2 ]   # adjust if needed

permissions:
  contents: read
  id-token: write   # required for OIDC token from GitHub [2](https://docs.github.com/en/actions/how-tos/secure-your-work/security-harden-deployments/oidc-in-google-cloud-platform)

env:
  GCP_PROJECT_ID: proven-country-485607-p6         # set in GitHub "Repository variables"
  GCP_PROJECT_NUMBER: 766156983150  # set in GitHub "Repository variables"
  WIF_POOL_ID: github-wif-pool                # e.g., github-actions-pool
  WIF_PROVIDER_ID: github      # e.g., github-oidc
  GCP_SA_EMAIL: github-wif-sa@proven-country-485607-p6.iam.gserviceaccount.com              # e.g., gha-list-vms@<project>.iam.gserviceaccount.com

jobs:
  list-vms:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Authenticate to Google Cloud using Workload Identity Federation
      - id: auth
        name: Auth to GCP (WIF)
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ env.WIF_POOL_ID }}/providers/${{ env.WIF_PROVIDER_ID }}
          service_account: ${{ env.GCP_SA_EMAIL }}
          token_format: access_token
          access_token_scopes: https://www.googleapis.com/auth/cloud-platform
      # Official auth action; requires id-token: write. [5](https://github.com/google-github-actions/auth)[2](https://docs.github.com/en/actions/how-tos/secure-your-work/security-harden-deployments/oidc-in-google-cloud-platform)

      # Install gcloud on the runner (uses the exported creds above)
      - uses: google-github-actions/setup-gcloud@v2
        with:
          version: ">= 466.0.0"

      # List Compute Engine VMs
      - name: List VMs
        run: |
          gcloud config set project "${GCP_PROJECT_ID}"
          gcloud compute instances list \
            --format="table(name,zone,status,networkInterfaces[0].networkIP,networkInterfaces[0].accessConfigs[0].natIP)"
        # gcloud reference for 'compute instances list'. [6](https://docs.cloud.google.com/sdk/gcloud/reference/compute/instances/list)